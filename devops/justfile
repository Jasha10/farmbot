set working-directory := '..'

publish $CARGO_API_TOKEN:
    # Use $CARGO_API_TOKEN rather than {{ CARGO_API_TOKEN }} to avoid
    # printing the token in just output.

    cargo install cargo-release
    cargo release
    # cargo publish --verbose --locked --token $CARGO_API_TOKEN

# Bump the version in Cargo.toml and Cargo.lock, commit the changes, and tag the commit
bump:
    cargo install cargo-release
    # Update Cargo.toml and Cargo.lock
    cargo release version patch --execute --no-confirm
    # commit the changes
    cargo release commit --execute --no-confirm
    cargo release tag --execute --no-confirm
    # just --justfile {{ justfile() }} tag

# # Create a git tag based on the version string found in Cargo.toml
# tag:
#   rg '^version = "\d+\.\d+\.\d+"$' Cargo.toml | sd '^version = "(\d+\.\d+\.\d+)"$' '$1' | xargs git tag

build:
  cargo build --all --verbose

test:
  cargo test --all --verbose
